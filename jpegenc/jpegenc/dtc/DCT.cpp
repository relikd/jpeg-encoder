#include "DCT.hpp"

//  ---------------------------------------------------------------
// |
// |  Constants and Helper
// |
//  ---------------------------------------------------------------

#define N 8

inline float getConstantC(unsigned char x, unsigned char y) { // (2.0F / N) * getC(i) * getC(j)
	if (x != 0 && y != 0)
		// most common clause (49 / 64)
		return 0.25;
	else if (x != 0 || y != 0)
		// second most common clause (14 / 64)
		return 0.176776695296636893184327732342353556305170059204101562;
	else
		// least common clause (1 / 64)
		return 0.125;
}

// float %1.25f  double %1.54f
static const float cos_2x1iPi_2N[8][8] = { // cos( (2x + 1)iπ / 2N )
	{ 1,  0.980785280403230449126182236134239036973933730893336095003,  0.923879532511286756128183189396788286822416625863642486116,  0.831469612302545237078788377617905756738560811987249963448,  0.707106781186547524400844362104849039284835937688474036591,  0.555570233019602224742830813948532874374937190754804045928,  0.38268343236508977172845998403039886676134456248562704144,   0.19509032201612826784828486847702224092769161775195480776 },
	{ 1,  0.831469612302545237078788377617905756738560811987249963447,  0.38268343236508977172845998403039886676134456248562704144,  -0.19509032201612826784828486847702224092769161775195480775,  -0.70710678118654752440084436210484903928483593768847403659,  -0.980785280403230449126182236134239036973933730893336095002, -0.92387953251128675612818318939678828682241662586364248612,  -0.55557023301960222474283081394853287437493719075480404593 },
	{ 1,  0.555570233019602224742830813948532874374937190754804045925, -0.38268343236508977172845998403039886676134456248562704143,  -0.980785280403230449126182236134239036973933730893336095003, -0.70710678118654752440084436210484903928483593768847403659,   0.19509032201612826784828486847702224092769161775195480775,   0.92387953251128675612818318939678828682241662586364248611,   0.83146961230254523707878837761790575673856081198724996345 },
	{ 1,  0.195090322016128267848284868477022240927691617751954807755, -0.923879532511286756128183189396788286822416625863642486115, -0.555570233019602224742830813948532874374937190754804045925,  0.707106781186547524400844362104849039284835937688474036587,  0.831469612302545237078788377617905756738560811987249963448, -0.382683432365089771728459984030398866761344562485627041431, -0.980785280403230449126182236134239036973933730893336095004 },
	{ 1, -0.195090322016128267848284868477022240927691617751954807754, -0.923879532511286756128183189396788286822416625863642486115,  0.555570233019602224742830813948532874374937190754804045923,  0.707106781186547524400844362104849039284835937688474036589, -0.831469612302545237078788377617905756738560811987249963445, -0.382683432365089771728459984030398866761344562485627041436,  0.980785280403230449126182236134239036973933730893336095002 },
	{ 1, -0.555570233019602224742830813948532874374937190754804045924, -0.382683432365089771728459984030398866761344562485627041434,  0.980785280403230449126182236134239036973933730893336095003, -0.707106781186547524400844362104849039284835937688474036588, -0.19509032201612826784828486847702224092769161775195480776,   0.923879532511286756128183189396788286822416625863642486116, -0.831469612302545237078788377617905756738560811987249963445 },
	{ 1, -0.831469612302545237078788377617905756738560811987249963446,  0.382683432365089771728459984030398866761344562485627041434,  0.195090322016128267848284868477022240927691617751954807755, -0.707106781186547524400844362104849039284835937688474036589,  0.980785280403230449126182236134239036973933730893336095003, -0.923879532511286756128183189396788286822416625863642486115,  0.55557023301960222474283081394853287437493719075480404592 },
	{ 1, -0.980785280403230449126182236134239036973933730893336095003,  0.923879532511286756128183189396788286822416625863642486115, -0.831469612302545237078788377617905756738560811987249963446,  0.707106781186547524400844362104849039284835937688474036588, -0.55557023301960222474283081394853287437493719075480404592,   0.38268343236508977172845998403039886676134456248562704143,  -0.19509032201612826784828486847702224092769161775195480775 }
};

static const float* matrixA = new float[64] {
	0.353553390593273730857504233426880091428756713867187500,  0.353553390593273730857504233426880091428756713867187500,  0.353553390593273730857504233426880091428756713867187500,  0.353553390593273730857504233426880091428756713867187500,  0.353553390593273730857504233426880091428756713867187500,  0.353553390593273730857504233426880091428756713867187500,  0.353553390593273730857504233426880091428756713867187500,  0.353553390593273730857504233426880091428756713867187500,
	0.490392640201615215289621119154617190361022949218750000,  0.415734806151272617835701339572551660239696502685546875,  0.277785116509801144335511935423710383474826812744140625,  0.097545161008064151797469776283833198249340057373046875, -0.097545161008064096286318545026006177067756652832031250, -0.277785116509800977802058241650229319930076599121093750, -0.415734806151272673346852570830378681421279907226562500, -0.490392640201615215289621119154617190361022949218750000,
	0.461939766255643369241568052530055865645408630371093750,  0.191341716182544918645191955874906852841377258300781250, -0.191341716182544863134040724617079831659793853759765625, -0.461939766255643369241568052530055865645408630371093750, -0.461939766255643369241568052530055865645408630371093750, -0.191341716182545168445372496535128448158502578735351562,  0.191341716182545001911918802761647384613752365112304688,  0.461939766255643258219265590014401823282241821289062500,
	0.415734806151272617835701339572551660239696502685546875, -0.097545161008064096286318545026006177067756652832031250, -0.490392640201615215289621119154617190361022949218750000, -0.277785116509801088824360704165883362293243408203125000,  0.277785116509800922290907010392402298748493194580078125,  0.490392640201615215289621119154617190361022949218750000,  0.097545161008064387719862509129598038271069526672363281, -0.415734806151272562324550108314724639058113098144531250,
	0.353553390593273786368655464684707112610340118408203125, -0.353553390593273730857504233426880091428756713867187500, -0.353553390593273841879806695942534133791923522949218750,  0.353553390593273730857504233426880091428756713867187500,  0.353553390593273841879806695942534133791923522949218750, -0.353553390593273342279445614622090943157672882080078125, -0.353553390593273619835201770911226049065589904785156250,  0.353553390593273286768294383364263921976089477539062500,
	0.277785116509801144335511935423710383474826812744140625, -0.490392640201615215289621119154617190361022949218750000,  0.097545161008064137919681968469376442953944206237792969,  0.415734806151272784369155033346032723784446716308593750, -0.415734806151272562324550108314724639058113098144531250, -0.097545161008064013019591698139265645295381546020507812,  0.490392640201615326311923581670271232724189758300781250, -0.277785116509800755757453316618921235203742980957031250,
	0.191341716182544918645191955874906852841377258300781250, -0.461939766255643369241568052530055865645408630371093750,  0.461939766255643258219265590014401823282241821289062500, -0.191341716182544918645191955874906852841377258300781250, -0.191341716182545279467674959050782490521669387817382812,  0.461939766255643369241568052530055865645408630371093750, -0.461939766255643147196963127498747780919075012207031250,  0.191341716182544779867313877730339299887418746948242188,
	0.097545161008064151797469776283833198249340057373046875, -0.277785116509801088824360704165883362293243408203125000,  0.415734806151272784369155033346032723784446716308593750, -0.490392640201615326311923581670271232724189758300781250,  0.490392640201615215289621119154617190361022949218750000, -0.415734806151272506813398877056897617876529693603515625,  0.277785116509800755757453316618921235203742980957031250, -0.097545161008064276697560046613943995907902717590332031
};



//  ---------------------------------------------------------------
// |
// |  Naive Sum DCT
// |
//  ---------------------------------------------------------------

void transform8x8_normal(float* &input, float* &output, size_t width) {
	unsigned char i,j,x,y;
	
	// jump through output
	i = N;
	while (i--) { // outer loop over output
		j = N;
		while (j--) {
			float inner = 0;
			
			// jump through input
			x = N;
			while (x--) { // inner loop over input
				y = N;
				while (y--) {
					inner += input[y + x * width] * cos_2x1iPi_2N[x][i] * cos_2x1iPi_2N[y][j];
				}
			}
			output[j + i * width] = getConstantC(i, j) * inner;
		}
	}
}

void DCT::transform(float* &input, float* &output, const size_t width, const size_t height) {
	float *ptIn = &input[0];
	float *ptOut = &output[0];
	
	unsigned short x, y;
	const unsigned short numOfCols = width / N; // otherwise will be calculated multiple times
	const size_t lineJump = width * (N - 1); // only N-1 because one line was already processed
	
	x = height / N;
	while (x--) {
		y = numOfCols;
		while (y--) {
			transform8x8_normal(ptIn, ptOut, width);
			ptIn += N;
			ptOut += N;
		}
		ptIn += lineJump;
		ptOut += lineJump;
	}
}



//  ---------------------------------------------------------------
// |
// |  Separated Matrix Multiplication
// |
//  ---------------------------------------------------------------

void multiplyMatrixAWith(float* &b, float* &result, const size_t width) {
	unsigned char x,y, i;
	y = N;
	while (y--) {
		x = N;
		while (x--) {
			float sum = 0;
			i = N;
			while (i--) { // multiplication loop
				sum += matrixA[y * N + i] * b[i * width + x];
			}
			result[y * width + x] = sum;
		}
	}
}
// two separate loops because its around 300.000 operations per second faster than an if (bool) clause
void multiplyWithTransposedMatrixA(float* &a, float* &result, const size_t width) {
	unsigned char x,y, i;
	y = N;
	while (y--) {
		x = N;
		while (x--) {
			float sum = 0;
			i = N;
			while (i--) { // multiplication loop
				sum += a[y * width + i] * matrixA[x * N + i];
			}
			result[y * width + x] = sum;
		}
	}
}

void transform8x8_separated(float* &input, float* &temp, const size_t width) {
//	float* temp = new float[64];
	multiplyMatrixAWith(input, temp, width); // a * input
	multiplyWithTransposedMatrixA(temp, input, width); // input * a^t
}

void DCT::transform2(float* &input, const size_t width, const size_t height) {
	float *ptIn = &input[0];
	
	unsigned short x, y;
	const unsigned short numOfCols = width / N; // otherwise will be calculated multiple times
	const size_t lineJump = width * (N - 1); // only N-1 because one line was already processed
	
	float* temp = new float[width * height];
	
	x = height / N;
	while (x--) {
		y = numOfCols;
		while (y--) {
			transform8x8_separated(ptIn, temp, width);
			ptIn += N;
		}
		ptIn += lineJump;
	}
	
	delete[] temp;
}



//  ---------------------------------------------------------------
// |
// |  Invers Calculation
// |
//  ---------------------------------------------------------------

void DCT::inverse(float* &input, float* &output) {
	unsigned char i,j,x,y;
	x = N;
	while (x--) { // outer loop over output
		y = N;
		while (y--) {
			float inner = 0;
			i = N;
			while (i--) { // inner loop over input
				j = N;
				while (j--) {
					float präfix = getConstantC(i, j) * input[j + i * N];
					inner += präfix * cos_2x1iPi_2N[x][i] * cos_2x1iPi_2N[y][j];
				}
			}
			output[y + x * N] = inner;
		}
	}
}
